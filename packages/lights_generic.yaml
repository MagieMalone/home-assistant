light:
  - platform: group
    unique_id: "c5dc244f-d629-4449-b1df-7724f7cf9f93"
    name: sk_spot
    entities:
      - light.sk_duo_spot_1
      - light.sk_duo_spot_2
  - platform: group
    unique_id: "31369779-f376-442a-9bef-151d46c299b0"
    name: keuken
    entities:
      - light.keuken_1
      - light.keuken_2
      - light.keuken_3
  - platform: group
    unique_id: "8f812a0b-a791-4712-80ef-330fe600e5e3"
    name: woonkamer
    entities:
      - light.hue_lightstrip_plus_1
      - light.staande_lamp
  - platform: group
    unique_id: "9a92f8b0-a07c-4e3a-b1ab-f7106caac260"
    name: eetkamer
    entities:
      - light.hue_color_pendant_down_1
      - light.hue_color_pendant_up_1
  - platform: group
    unique_id: "23310601-9579-47a4-86a4-045ebcd93914"
    name: zolder_en_trap
    entities:
      - light.overloop
      - light.trap_hal
      - light.zoldervoor
      - light.zolderachter
  - platform: group
    unique_id: "90f9c500-8281-47d4-b840-6b7d949cbe20"
    name: slaapkamer
    entities:
      - light.sk_ceiling
      - light.sk_duo_spot_1
      - light.sk_duo_spot_2
  - platform: group
    unique_id: "34afeb0e-a49e-4dd2-b3cd-3c4d118b023c"
    name: color
    entities:
      - light.hue_lightstrip_plus_1
      - light.staande_lamp
      - light.hue_color_pendant_down_1
      - light.hue_color_pendant_up_1
      - light.computer
      - light.hal
      - light.zoldervoor
      - light.zolderachter
      - light.sk_ceiling
  - platform: group
    unique_id: "b99afc0f-ddba-48cd-a8e1-49b7675c0dd0"
    name: whites
    entities:
      - light.sk_duo_spot_1
      - light.sk_duo_spot_2
      - light.overloop
      - light.keuken_1
      - light.keuken_2
      - light.keuken_3
      - light.trap_hal
  - platform: group
    unique_id: "44895708-5ac6-4f2a-98ea-aee477f7ff66"
    name: lampen
    entities:
      - light.hue_lightstrip_plus_1
      - light.staande_lamp
      - light.hue_color_pendant_down_1
      - light.hue_color_pendant_up_1
      - light.computer
      - light.hal
      - light.zoldervoor
      - light.zolderachter
      - light.sk_ceiling
      - light.sk_duo_spot_1
      - light.sk_duo_spot_2
      - light.overloop
      - light.keuken_1
      - light.keuken_2
      - light.keuken_3
      - light.trap_hal
group:
  switch-wk:
    entities:
      - switch.woonkamer_la
      - switch.woonkamer_ra
      - switch.woonkamer_media
  motion_sensors:
    entities:
      - binary_sensor.hal_occupancy
      - binary_sensor.overloop_occupancy
      - binary_sensor.traphal_occupancy

input_number:
  lightlevel:
    name: light level for motion sensors
    min: 0
    max: 200
    step: 5
    unit_of_measurement: lx

#binary_sensor:
# custom hue component
#  - platform: huesensor
#remote:
#custom hue component
#  - platform: hueremote
#light:
#  - platform: rflink
#    automatic_add: true
script:
  flash_lights:
    sequence:
      - variables:
          light_entities: "{{states.light|rejectattr('state', 'eq', 'off')|selectattr('attributes.entity_id', 'undefined')|map(attribute='entity_id')|list}} "
      - choose:
          - conditions:
              - "{{ light_entities == '' }}"
            sequence:
              - service: light.turn_on
                target:
                  entity_id:
                    - light.hue_lightstrip_plus_1
                    - light.hal
              - variables:
                  light_hal: "{{state_attr('light.hal', 'brightness')|int}}"
                  light_lightstrip: "{{state_attr('light.hue_lightstrip_plus_1', 'brightness')|int}}"
              - service: light.turn_on
                target:
                  entity_id:
                    - light.hue_lightstrip_plus_1
                    - light.hal
                data:
                  brightness: 100
              - service: light.turn_on
                target:
                  entity_id:
                    - light.hue_lightstrip_plus_1
                    - light.hal
                data:
                  flash: long
              - delay: 5
              - service: light.turn_on
                target:
                  entity_id: light.hue_lightstrip_plus_1
                data:
                  brightness: "{{light_lightstrip}}"
              - service: light.turn_on
                target:
                  entity_id: light.hal
                data:
                  brightness: "{{light_hal}}"
              - service: light.turn_off
                target:
                  entity_id:
                    - light.hue_lightstrip_plus_1
                    - light.hal
        default:
          - service: light.turn_on
            target:
              entity_id: "{{light_entities}}"
            data:
              flash: long
  update_lights_attributes:
    fields:
      brightness_pct:
        description: "brightness in %"
        example: "75"
      transition:
        description: "transition time in seconds"
        example: "1"
      xy_color:
        description: "color in xy color notation"
        example: "[0.5, 0.5]"
    sequence:
      - service: light.turn_on
        target:
          entity_id: "{{states.light|rejectattr('state', 'eq', 'off')|selectattr('attributes.entity_id', 'undefined')|map(attribute='entity_id')|list}}"
        data: >
          {% if brightness_pct and transition and xy_color %}
            {% set data = {"brightness_pct":  brightness_pct, "transition": transition, "xy_color": xy_color} %}
          {% elif brightness_pct and transition %}
            {% set data = {"brightness_pct":  brightness_pct, "transition": transition} %}
          {% elif  brightness_pct %}
            {% set data = {"brightness_pct":  brightness_pct } %}
          {% else %}
            {% set data = {"brightness_pct":  100} %}
          {% endif %}
          {{ data }}


automation:
  - alias: "lights off when leaving"
    id: "782368093283658209"
    trigger:
      - platform: state
        entity_id: input_select.arnoud_status
        to: "Net Weg"
        for: 
          minutes: 3
    action:
      - service: homeassistant.turn_off
        target:
          entity_id:
            - light.lampen
            - switch.tplink_b0_4e_26_6b_a1_f5

  - alias: "sunrise lights off"
    id: "47893265301237"
    trigger:
      platform: sun
      event: sunrise
      offset: "00:20:00"
    condition:
      - condition: state
        entity_id: input_boolean.cleaningmode
        state: "off"
      - condition: state
        entity_id: script.wakeup_light
        state: "off"
    action:
      - service: light.turn_off
        target:
          entity_id: light.lampen

  - alias: "lights off weekdays"
    id: "1528912303194"
    trigger:
      #- platform: time
      #  at:
      #    - input_datetime.bedtime
      - at: "23:59:59"
        platform: time
    condition:
      condition: state
      entity_id: binary_sensor.workday1d
      state: "on"
    action:
      - service: light.turn_off
        target:
          entity_id: light.lampen
        data:
          transition: 900

  - alias: "lights off weekenddays"
    id: "1528912303472"
    trigger:
      - at: "01:00:00"
        platform: time
    condition:
      condition: state
      entity_id: binary_sensor.workday_sensor
      state: "off"
    action:
      - service: light.turn_off
        target:
          entity_id: light.lampen
        data:
          transition: 900

  - alias: "dim lights in day"
    id: "54618293609860132486029"
    trigger:
      - platform: state
        entity_id: input_select.house_mode
        to: "overdag"
    condition:
      condition: state
      entity_id: light.lampen
      state: "on"
    action:
      - service: script.update_lights_attributes
        data:
          brightness_pct: 75
          transition: 60

  - alias: "dim lights in avond"
    id: "235689056329850982360158"
    trigger:
      - platform: state
        entity_id: input_select.house_mode
        to: "avond"
    condition:
      condition: state
      entity_id: light.lampen
      state: "on"
    action:
      - service: script.update_lights_attributes
        data:
          brightness_pct: 50
          transition: 60

  - alias: "dim lights in nacht"
    id: "56132890612345689532108"
    trigger:
      - platform: state
        entity_id: input_select.house_mode
        to: "nacht"
    condition:
      condition: state
      entity_id: light.lampen
      state: "on"
    action:
      - service: scene.create
        data:
          scene_id: before
          snapshot_entities:
            - light.hue_lightstrip_plus_1
            - light.staande_lamp
            - light.hue_color_pendant_down_1
            - light.hue_color_pendant_up_1
            - light.computer
            - light.hal
            - light.zoldervoor
            - light.zolderachter
            - light.sk_ceiling
            - light.sk_duo_spot_1
            - light.sk_duo_spot_2
            - light.overloop
            - light.keuken_1
            - light.keuken_2
            - light.keuken_3
            - light.trap_hal
      - service: script.update_lights_attributes
        data:
          brightness_pct: 10
          transition: 2
          xy_color:
            - 0.167
            - 0.04
      - delay:
          seconds: 5
      - service: scene.turn_on
        target:
          entity_id: scene.before
        data:
          transition: 2
